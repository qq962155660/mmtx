<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~  Copyright 1999-2019 Mmtx.io Group.
  ~
  ~  Licensed under the Apache License, Version 2.0 (the "License");
  ~  you may not use this file except in compliance with the License.
  ~  You may obtain a copy of the License at
  ~
  ~       http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~  Unless required by applicable law or agreed to in writing, software
  ~  distributed under the License is distributed on an "AS IS" BASIS,
  ~  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~  See the License for the specific language governing permissions and
  ~  limitations under the License.
  -->
<project xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd" xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <modelVersion>4.0.0</modelVersion>
  <parent>
    <groupId>io.mmtx</groupId>
    <artifactId>mmtx-parent</artifactId>
    <version>1.0.0</version>
  </parent>
  <groupId>io.mmtx</groupId>
  <artifactId>mmtx-server</artifactId>
  <version>1.0.0</version>
  <name>mmtx-server ${project.version}</name>
  <licenses>
    <license>
      <name>Apache License, Version 2.0</name>
      <url>http://www.apache.org/licenses/LICENSE-2.0</url>
      <distribution>repo</distribution>
    </license>
  </licenses>
  <dependencies>
    <dependency>
      <groupId>${project.groupId}</groupId>
      <artifactId>mmtx-core</artifactId>
      <version>${project.version}</version>
    </dependency>
    <dependency>
      <groupId>${project.groupId}</groupId>
      <artifactId>mmtx-config-all</artifactId>
      <version>${project.version}</version>
    </dependency>
    <dependency>
      <groupId>${project.groupId}</groupId>
      <artifactId>mmtx-discovery-all</artifactId>
      <version>${project.version}</version>
    </dependency>
    <dependency>
      <groupId>${project.groupId}</groupId>
      <artifactId>mmtx-codec-all</artifactId>
      <version>${project.version}</version>
    </dependency>
    <dependency>
      <groupId>${project.groupId}</groupId>
      <artifactId>mmtx-compressor-all</artifactId>
      <version>${project.version}</version>
    </dependency>
    <dependency>
      <groupId>${project.groupId}</groupId>
      <artifactId>mmtx-metrics-all</artifactId>
      <version>${project.version}</version>
    </dependency>
    <dependency>
      <groupId>com.alibaba</groupId>
      <artifactId>druid</artifactId>
    </dependency>
    <dependency>
      <groupId>commons-dbcp</groupId>
      <artifactId>commons-dbcp</artifactId>
    </dependency>
    <dependency>
      <groupId>com.h2database</groupId>
      <artifactId>h2</artifactId>
    </dependency>
    <dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
    </dependency>
    <dependency>
      <groupId>com.beust</groupId>
      <artifactId>jcommander</artifactId>
    </dependency>
  </dependencies>
  <build>
    <plugins>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>appassembler-maven-plugin</artifactId>
        <version>1.10</version>
        <executions>
          <execution>
            <id>make-assembly</id>
            <phase>package</phase>
            <goals>
              <goal>assemble</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <configurationDirectory>conf</configurationDirectory>
          <configurationSourceDirectory>src/main/resources</configurationSourceDirectory>
          <copyConfigurationDirectory>true</copyConfigurationDirectory>
          <includeConfigurationDirectoryInClasspath>true</includeConfigurationDirectoryInClasspath>
          <repositoryLayout>flat</repositoryLayout>
          <repositoryName>lib</repositoryName>
          <encoding>UTF-8</encoding>
          <useWildcardClassPath>true</useWildcardClassPath>
          <binFileExtensions>
            <unix>.sh</unix>
            <windows>.bat</windows>
          </binFileExtensions>
          <assembleDirectory>../distribution</assembleDirectory>
          <logsDirectory>logs</logsDirectory>
          <programs>
            <program>
              <mainClass>io.mmtx.server.Server</mainClass>
              <name>mmtx-server</name>
              <jvmSettings>
                <extraArguments>
                  <extraArgument>-server</extraArgument>
                  <extraArgument>-Xmx512m</extraArgument>
                  <extraArgument>-Xms512m</extraArgument>
                  <extraArgument>-Xmn256m</extraArgument>
                  <extraArgument>-Xss512k</extraArgument>
                  <extraArgument>-XX:SurvivorRatio=10</extraArgument>
                  <extraArgument>-XX:MetaspaceSize=32m</extraArgument>
                  <extraArgument>-XX:MaxMetaspaceSize=64m</extraArgument>
                  <extraArgument>-XX:MaxDirectMemorySize=1024m</extraArgument>
                  <extraArgument>-XX:-OmitStackTraceInFastThrow</extraArgument>
                  <extraArgument>-XX:-UseAdaptiveSizePolicy</extraArgument>
                  <extraArgument>-XX:+HeapDumpOnOutOfMemoryError</extraArgument>
                  <extraArgument>-XX:HeapDumpPath=@BASEDIR@/logs/java_heapdump.hprof</extraArgument>
                  <extraArgument>-XX:+DisableExplicitGC</extraArgument>
                  <extraArgument>-XX:+CMSParallelRemarkEnabled</extraArgument>
                  <extraArgument>-XX:+UseCMSInitiatingOccupancyOnly</extraArgument>
                  <extraArgument>-XX:CMSInitiatingOccupancyFraction=75</extraArgument>
                  <extraArgument>-Xloggc:@BASEDIR@/logs/mmtx_gc.log</extraArgument>
                  <extraArgument>-verbose:gc</extraArgument>
                  <extraArgument>-Dio.netty.leakDetectionLevel=advanced</extraArgument>
                </extraArguments>
              </jvmSettings>
              <platforms>
                <platform>windows</platform>
                <platform>unix</platform>
              </platforms>
            </program>
          </programs>
        </configuration>
      </plugin>
      <plugin>
        <groupId>com.google.cloud.tools</groupId>
        <artifactId>jib-maven-plugin</artifactId>
        <version>1.7.0</version>
        <executions>
          <execution>
            <phase>package</phase>
            <goals>
              <goal>build</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <from>
            <image>${IMAGE_NAME}</image>
          </from>
          <to>
            <image>docker.io/mmtxio/mmtx-server</image>
            <tags>${image.tags}</tags>
            <auth>
              <username>${REGISTRY_USERNAME}</username>
              <password>${REGISTRY_PASSWORD}</password>
            </auth>
          </to>
          <container>
            <appRoot>/mmtx-server</appRoot>
            <workingDirectory>/mmtx-server</workingDirectory>
            <mainClass>io.mmtx.server.Server</mainClass>
            <ports>
              <port>8091</port>
            </ports>
            <jvmFlags>
              <jvmFlag>-Djava.security.egd=file:/dev/./urandom</jvmFlag>
              <jvmFlag>-server</jvmFlag>
              <jvmFlag>-Xss512k</jvmFlag>
              <jvmFlag>-XX:+UnlockExperimentalVMOptions</jvmFlag>
              <jvmFlag>-XX:+UseContainerSupport</jvmFlag>
              <jvmFlag>-XX:SurvivorRatio=10</jvmFlag>
              <jvmFlag>-XX:MetaspaceSize=128m</jvmFlag>
              <jvmFlag>-XX:MaxMetaspaceSize=256m</jvmFlag>
              <jvmFlag>-XX:MaxDirectMemorySize=1024m</jvmFlag>
              <jvmFlag>-XX:-OmitStackTraceInFastThrow</jvmFlag>
              <jvmFlag>-XX:-UseAdaptiveSizePolicy</jvmFlag>
              <jvmFlag>-XX:+HeapDumpOnOutOfMemoryError</jvmFlag>
              <jvmFlag>-XX:HeapDumpPath=/var/log/mmtx_heapdump.hprof</jvmFlag>
              <jvmFlag>-XX:+DisableExplicitGC</jvmFlag>
              <jvmFlag>-XX:+CMSParallelRemarkEnabled</jvmFlag>
              <jvmFlag>-XX:+UseCMSInitiatingOccupancyOnly</jvmFlag>
              <jvmFlag>-XX:CMSInitiatingOccupancyFraction=75</jvmFlag>
              <jvmFlag>-Xloggc:/var/log/mmtx_gc.log</jvmFlag>
              <jvmFlag>-verbose:gc</jvmFlag>
              <jvmFlag>-Dio.netty.leakDetectionLevel=advanced</jvmFlag>
            </jvmFlags>
            <labels>
              <name>mmtx-server</name>
            </labels>
            <creationTime>USE_CURRENT_TIMESTAMP</creationTime>
          </container>
          <skip>${image.publish.skip}</skip>
        </configuration>
      </plugin>
    </plugins>
  </build>
</project>
